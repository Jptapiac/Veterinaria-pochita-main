{% extends "base.html" %}

{% block title %}Agendar Cita - Veterinaria Pochita{% endblock %}

{% block extra_css %}
<style>
    .wizard-container {
        max-width: 1000px;
        margin: 0 auto;
    }
    
    .wizard-steps {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2rem;
        position: relative;
    }
    
    .wizard-steps::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 0;
        right: 0;
        height: 2px;
        background: #dee2e6;
        z-index: 0;
    }
    
    .wizard-step {
        flex: 1;
        text-align: center;
        position: relative;
        z-index: 1;
    }
    
    .wizard-step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #dee2e6;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin: 0 auto 0.5rem;
        transition: all 0.3s;
    }
    
    .wizard-step.active .wizard-step-number {
        background: #0d6efd;
    }
    
    .wizard-step.completed .wizard-step-number {
        background: #28a745;
    }
    
    .wizard-step-label {
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    .wizard-step.active .wizard-step-label {
        color: #0d6efd;
        font-weight: 600;
    }
    
    .wizard-content {
        min-height: 400px;
    }
    
    .wizard-panel {
        display: none;
    }
    
    .wizard-panel.active {
        display: block;
    }
    
    .vet-card {
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 1.5rem;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 1rem;
        background: white;
    }
    
    .vet-card:hover {
        border-color: #0d6efd;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .vet-card.selected {
        border-color: #0d6efd;
        background: #e7f5ff;
    }
    
    .time-slot-btn {
        width: 100%;
        padding: 1rem;
        text-align: center;
        border: 1px solid #0d6efd;
        background: white;
        color: #0d6efd;
        border-radius: 6px;
        font-weight: 600;
        font-size: 1.1rem;
        transition: all 0.2s;
        cursor: pointer;
        margin-bottom: 0.5rem;
    }
    
    .time-slot-btn:hover {
        background: #0d6efd;
        color: white;
    }
    
    .time-slot-btn.selected {
        background: #0d6efd;
        color: white;
        box-shadow: 0 2px 8px rgba(13, 110, 253, 0.4);
    }
    
    .pet-card {
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 1.5rem;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 1rem;
    }
    
    .pet-card:hover {
        border-color: #28a745;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .pet-card.selected {
        border-color: #28a745;
        background: #d4edda;
    }
    
    .summary-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
    }
    
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
    }
    
    .calendar-day {
        border: 1px solid #dee2e6;
        padding: 0.75rem;
        text-align: center;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .calendar-day.has-slots {
        border-color: #28a745;
        background: #f8fff9;
    }
    
    .calendar-day.selected {
        background: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }
    
    .calendar-day.opacity-50 {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="wizard-container">
        <div class="text-center mb-4">
            <h1 class="h2">
                <i class="fas fa-calendar-plus"></i> Agendar Nueva Cita
            </h1>
            <p class="text-muted">Revisa las próximas horas que tenemos disponibles para ti</p>
        </div>
        
        <!-- Alert Messages -->
        <div id="booking-alert" class="alert d-none" role="alert"></div>
        
        <!-- Wizard Steps -->
        <div class="wizard-steps">
            <div class="wizard-step active" data-step="1">
                <div class="wizard-step-number">1</div>
                <div class="wizard-step-label">Búsqueda</div>
            </div>
            <div class="wizard-step" data-step="2">
                <div class="wizard-step-number">2</div>
                <div class="wizard-step-label">Selección</div>
            </div>
            <div class="wizard-step" data-step="3">
                <div class="wizard-step-number">3</div>
                <div class="wizard-step-label">Identificación</div>
            </div>
            <div class="wizard-step" data-step="4">
                <div class="wizard-step-number">4</div>
                <div class="wizard-step-label">Reserva Exitosa</div>
            </div>
        </div>
        
        <!-- Wizard Content -->
        <div class="wizard-content">
            <!-- Step 1: Búsqueda - Seleccionar Veterinario -->
            <div class="wizard-panel active" id="step-1">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-search"></i> Paso 1: Búsqueda
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-4">Revisa las próximas horas que tenemos disponibles para ti.</p>
                        
                        <div class="row">
                            <!-- Columna Izquierda: Seleccionar Área -->
                            <div class="col-md-4">
                                <h6 class="mb-3">1. Seleccione Área</h6>
                                <div class="list-group">
                                    <label class="list-group-item">
                                        <input type="radio" name="medical-area" value="CONSULTA_VETERINARIA" class="form-check-input me-2" checked>
                                        Consulta Veterinaria
                                    </label>
                                    <label class="list-group-item">
                                        <input type="radio" name="medical-area" value="EXAMENES" class="form-check-input me-2">
                                        Exámenes
                                    </label>
                                    <label class="list-group-item">
                                        <input type="radio" name="medical-area" value="IMAGENOLOGIA" class="form-check-input me-2">
                                        Imagenología
                                    </label>
                                    <label class="list-group-item">
                                        <input type="radio" name="medical-area" value="CONSULTA_ESPECIALISTA" class="form-check-input me-2">
                                        Consulta Especialista
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Columna Derecha: Búsqueda -->
                            <div class="col-md-8">
                                <h6 class="mb-3">2. Búsqueda</h6>
                                
                                <div class="mb-3">
                                    <label class="form-label">Seleccione Servicio</label>
                                    <select class="form-select" id="service-selector">
                                        <option value="CONSULTA_VETERINARIA">Consulta Veterinaria</option>
                                        <option value="VACUNACION">Vacunación</option>
                                        <option value="ESTERILIZACION">Esterilización</option>
                                        <option value="URGENCIA">Urgencia</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Sucursal</label>
                                    <select class="form-select" id="branch-selector">
                                        <option value="CHIGUAYANTE" selected>Chiguayante</option>
                                    </select>
                                </div>
                                
                                <button type="button" class="btn btn-primary" id="btn-buscar-servicio">
                                    <i class="fas fa-search"></i> Buscar Hora
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step 2: Selección - Veterinario, Fecha y Hora -->
            <div class="wizard-panel" id="step-2">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-calendar-alt"></i> Selección
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Lista de Veterinarios -->
                        <div id="veterinarians-selection-section">
                            <h6 class="mb-3">Veterinarios disponibles en <span id="selected-branch-name"></span>:</h6>
                            <div id="veterinarians-list-step2">
                                <p class="text-center text-muted">Cargando veterinarios...</p>
                            </div>
                        </div>
                        
                        <!-- Selección de Fecha y Hora (oculto hasta seleccionar veterinario) -->
                        <div id="date-time-selection-section" class="d-none">
                            <div class="summary-card mb-4">
                                <h6>Veterinario seleccionado:</h6>
                                <p id="selected-vet-name" class="mb-0"></p>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <label class="form-label">Seleccione el mes:</label>
                                    <input type="month" class="form-control" id="month-selector">
                                </div>
                            </div>
                            
                            <div id="calendar-container" class="mb-4">
                                <!-- Calendario se carga aquí -->
                            </div>
                            
                            <div id="time-slots-container" class="d-none">
                                <h6 class="mb-3">Seleccione una de las siguientes horas disponibles:</h6>
                                <p class="text-muted mb-3">Horarios disponibles para <span id="selected-date-text"></span>:</p>
                                <div id="time-slots-list">
                                    <!-- Horarios se cargan aquí -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step 3: Identificación -->
            <div class="wizard-panel" id="step-3">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-user"></i> Paso 3: Identificación
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="summary-card mb-4">
                            <h6>Resumen de la cita seleccionada:</h6>
                            <p class="mb-1"><strong>Veterinario:</strong> <span id="summary-vet-step3"></span></p>
                            <p class="mb-1"><strong>Fecha:</strong> <span id="summary-date-step3"></span></p>
                            <p class="mb-0"><strong>Hora:</strong> <span id="summary-time-step3"></span></p>
                        </div>
                        
                        <!-- Si NO está autenticado: Mostrar solo Registro -->
                        <div id="auth-section-step3">
                            <div class="text-center mb-4">
                                <h6 class="mb-3">Registrarse para completar la reserva</h6>
                                <p class="text-muted mb-4">Crea tu cuenta y registra tu mascota para finalizar la reserva</p>
                                <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#registerWithPetModal">
                                    <i class="fas fa-user-plus"></i> Registrarse con Mascota
                                </button>
                            </div>
                        </div>
                        
                        <!-- Si está autenticado: Mostrar que ya está listo -->
                        <div id="authenticated-section-step3" class="d-none">
                            <!-- Mensaje cuando no tiene mascotas -->
                            <div id="no-pets-message-step3" class="d-none">
                                <div class="alert alert-warning mb-4">
                                    <i class="fas fa-exclamation-triangle"></i> No tiene mascotas registradas. Por favor registre una mascota primero.
                                </div>
                                <div class="text-center">
                                    <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#registerWithPetModal">
                                        <i class="fas fa-plus"></i> Agregar Mascota
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Mensaje cuando tiene mascotas -->
                            <div id="ready-to-confirm-message-step3" class="d-none">
                                <div class="alert alert-success mb-4">
                                    <i class="fas fa-check-circle"></i> Sesión iniciada correctamente
                                </div>
                                <p class="text-center text-muted">Tu reserva está lista para ser confirmada.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step 4: Reserva Exitosa -->
            <div class="wizard-panel" id="step-4">
                <div class="card">
                    <div class="card-body text-center py-5">
                        <div class="mb-4">
                            <i class="fas fa-check-circle text-success" style="font-size: 5rem;"></i>
                        </div>
                        <h2 class="text-success mb-3">¡Reserva Exitosa!</h2>
                        <p class="lead mb-4">Tu cita ha sido agendada correctamente</p>
                        
                        <div class="summary-card mb-4" style="max-width: 500px; margin: 0 auto;">
                            <h6>Detalles de tu cita:</h6>
                            <p class="mb-1"><strong>Veterinario:</strong> <span id="confirm-vet"></span></p>
                            <p class="mb-1"><strong>Fecha:</strong> <span id="confirm-date"></span></p>
                            <p class="mb-1"><strong>Hora:</strong> <span id="confirm-time"></span></p>
                            <p class="mb-0"><strong>Mascota:</strong> <span id="confirm-pet"></span></p>
                        </div>
                        
                        <div class="alert alert-info mt-4">
                            <i class="fas fa-info-circle"></i> Serás redirigido automáticamente a tu panel principal en unos segundos...
                        </div>
                        
                        <div class="mt-3">
                            <a href="/dashboard/" class="btn btn-primary me-2">
                                <i class="fas fa-tachometer-alt"></i> Ir al Dashboard Ahora
                            </a>
                            <a href="/login/" class="btn btn-outline-primary">
                                <i class="fas fa-sign-in-alt"></i> Iniciar Sesión
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Navigation Buttons -->
        <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-secondary" id="btn-prev" style="display: none;">
                <i class="fas fa-arrow-left"></i> Atrás
            </button>
            <div class="ms-auto">
                <button type="button" class="btn btn-primary" id="btn-next">
                    Siguiente <i class="fas fa-arrow-right"></i>
                </button>
                <button type="button" class="btn btn-success d-none" id="btn-confirm">
                    <i class="fas fa-check"></i> Confirmar Cita
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Registro con Mascota -->
<div class="modal fade" id="registerWithPetModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus"></i> Registrarse y Agregar Mascota
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="register-with-pet-alert" class="alert d-none" role="alert"></div>
                
                <form id="register-with-pet-form">
                    <h6 class="mb-3"><i class="fas fa-user"></i> Tus Datos</h6>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Usuario *</label>
                            <input type="text" class="form-control" id="reg-username-with-pet" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-control" id="reg-email-with-pet" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nombre *</label>
                            <input type="text" class="form-control" id="reg-first-name-with-pet" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Apellido *</label>
                            <input type="text" class="form-control" id="reg-last-name-with-pet" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">RUT</label>
                            <input type="text" class="form-control" id="reg-rut-with-pet" placeholder="12345678-9">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Teléfono</label>
                            <input type="text" class="form-control" id="reg-phone-with-pet" placeholder="+56912345678">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Contraseña *</label>
                            <input type="password" class="form-control" id="reg-password-with-pet" required>
                            <small class="text-muted">Mínimo 8 caracteres</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Confirmar Contraseña *</label>
                            <input type="password" class="form-control" id="reg-password-confirm-with-pet" required>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <h6 class="mb-3"><i class="fas fa-paw"></i> Datos de la Mascota</h6>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nombre de la Mascota *</label>
                            <input type="text" class="form-control" id="reg-pet-name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Especie *</label>
                            <select class="form-select" id="reg-pet-species" required>
                                <option value="">Seleccione...</option>
                                <option value="PERRO">Perro</option>
                                <option value="GATO">Gato</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Raza</label>
                            <input type="text" class="form-control" id="reg-pet-breed">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Sexo *</label>
                            <select class="form-select" id="reg-pet-gender" required>
                                <option value="">Seleccione...</option>
                                <option value="MACHO">Macho</option>
                                <option value="HEMBRA">Hembra</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Fecha de Nacimiento</label>
                            <input type="date" class="form-control" id="reg-pet-birth-date" max="" min="">
                            <small class="text-muted" id="birth-date-help">Seleccione la especie para ver los límites de edad</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Color</label>
                            <input type="text" class="form-control" id="reg-pet-color">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Peso (kg)</label>
                            <input type="number" step="0.1" class="form-control" id="reg-pet-weight">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="register-with-pet-submit">
                    <i class="fas fa-user-plus"></i> Registrarse y Crear Cuenta
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/book_appointment.js"></script>
{% endblock %}
